{% extends 'base.html' %}
{% block title %}Chat - AI Document Assistant{% endblock %}
{% block content %}
<div class="mx-auto max-w-7xl px-4 py-6">
  <div class="flex items-center justify-between mb-4">
    <h1 class="text-2xl font-semibold tracking-tight">Ready to help with your documents</h1>
    <div class="inline-flex items-center gap-2 rounded-full border px-3 py-1 text-sm bg-white/60 backdrop-blur supports-[backdrop-filter]:bg-white/40 dark:bg-gray-800/60">
      <span class="inline-block h-2 w-2 rounded-full bg-green-500"></span>
      <span>{{ agent_status.status|title }}</span>
      <span class="text-gray-500 hidden sm:inline">• {{ agent_status.message }}</span>
    </div>
  </div>

  <div class="grid grid-cols-1 lg:grid-cols-12 gap-6">
    <!-- Sidebar: Files -->
    <aside class="lg:col-span-3">
      <div class="rounded-2xl border bg-white/70 dark:bg-gray-900/70 backdrop-blur p-4">
        <div class="flex items-center justify-between mb-3">
          <h2 class="font-medium">Your Files</h2>
          <a href="{% url 'qna_app:upload' %}" class="text-blue-600 hover:underline text-sm">Manage</a>
        </div>
        {% if uploaded_files %}
          <ul class="space-y-2 max-h-[50vh] overflow-auto pr-1">
            {% for file in uploaded_files %}
              <li class="rounded-xl border p-3 hover:bg-gray-50 dark:hover:bg-gray-800 transition">
                <div class="text-sm font-medium truncate">{{ file.original_filename }}</div>
                <div class="text-xs text-gray-500 flex items-center gap-2">
                  <span class="uppercase">{{ file.file_type }}</span>
                  <span>•</span>
                  <span>{{ file.get_file_size_display }}</span>
                </div>
              </li>
            {% endfor %}
          </ul>
        {% else %}
          <div class="text-sm text-gray-500">No files uploaded yet — add one to unlock document-aware answers.</div>
        {% endif %}
        <form method="post" class="mt-4">
          {% csrf_token %}
          <input type="hidden" name="action" value="clear_session" />
          <button class="w-full rounded-xl border px-3 py-2 text-sm hover:bg-gray-50 dark:hover:bg-gray-800">Clear Chat</button>
        </form>
      </div>
    </aside>

    <!-- Chat thread -->
    <main class="lg:col-span-9">
      <div class="rounded-2xl border bg-white/70 dark:bg-gray-900/70 backdrop-blur flex flex-col h-[70vh]">
        <!-- Messages -->
        <div id="chat-thread" class="flex-1 overflow-auto p-4 space-y-4">
          {% for conv in recent_conversations reversed %}
            <div class="flex flex-col gap-2">
              <div class="self-end max-w-[85%] rounded-2xl border bg-blue-50 dark:bg-blue-900/30 px-4 py-3 shadow-sm">
                <div class="text-sm text-gray-800 dark:text-gray-100 whitespace-pre-wrap">{{ conv.user_message }}</div>
              </div>
              <div class="self-start max-w-[85%] rounded-2xl border bg-gray-50 dark:bg-gray-800 px-4 py-3 shadow-sm">
                <div class="text-sm text-gray-900 dark:text-gray-100 whitespace-pre-wrap">{{ conv.agent_response }}</div>
                {% if conv.response_time_seconds %}
                  <div class="mt-1 text-[11px] text-gray-500">Responded in {{ conv.response_time_seconds|floatformat:2 }}s</div>
                {% endif %}
              </div>
            </div>
          {% empty %}
            <div class="text-sm text-gray-500 px-2">
              Start a conversation and get contextual answers from your documents and the web.
            </div>
          {% endfor %}
        </div>

        <!-- Composer -->
        <div class="border-t p-3">
          <form id="chat-form" class="flex gap-2 items-end">
            {% csrf_token %}
            <textarea id="message-input" name="message" rows="2" required
              class="flex-1 rounded-xl border px-3 py-3 focus:outline-none focus:ring-2 focus:ring-blue-500 resize-none"
              placeholder="Ask anything about your files or general questions... (Press Enter to send)"></textarea>
            <button id="send-btn" type="submit"
              class="rounded-xl bg-blue-600 text-white px-4 py-3 hover:bg-blue-700 active:bg-blue-800">
              Send
            </button>
          </form>
          <p class="text-xs text-gray-500 mt-2">Press Enter to send, Shift+Enter for new line</p>
        </div>
      </div>
    </main>
  </div>
</div>

<script>
  const thread = document.getElementById('chat-thread');
  const form = document.getElementById('chat-form');
  const textarea = document.getElementById('message-input');
  const sendBtn = document.getElementById('send-btn');

  textarea.addEventListener('keydown', (e) => {
    if (e.key === 'Enter' && !e.shiftKey) {
      e.preventDefault();
      form.requestSubmit();
    }
  });

  form.addEventListener('submit', async (e) => {
    e.preventDefault();
    const msg = textarea.value.trim();
    if (!msg) return;

    // Optimistic render
    appendBubble(msg, 'user');
    textarea.value = '';
    sendBtn.disabled = true;

    try {
      const res = await fetch("{% url 'qna_app:api_chat' %}", {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
        },
        body: JSON.stringify({ message: msg })
      });
      const data = await res.json();
      if (data.success) {
        appendBubble(data.response, 'agent');
      } else {
        appendBubble(data.error || 'Something went wrong.', 'agent');
      }
    } catch (err) {
      appendBubble('Network error. Please try again.', 'agent');
    } finally {
      sendBtn.disabled = false;
      thread.scrollTop = thread.scrollHeight;
    }
  });

  function appendBubble(text, role) {
    const wrap = document.createElement('div');
    wrap.className = 'flex flex-col gap-2';
    const bubble = document.createElement('div');
    bubble.className = (role === 'user'
      ? 'self-end max-w-[85%] rounded-2xl border bg-blue-50 dark:bg-blue-900/30 px-4 py-3 shadow-sm'
      : 'self-start max-w-[85%] rounded-2xl border bg-gray-50 dark:bg-gray-800 px-4 py-3 shadow-sm');
    const p = document.createElement('div');
    p.className = 'text-sm text-gray-900 dark:text-gray-100 whitespace-pre-wrap';
    p.textContent = text;
    bubble.appendChild(p);
    wrap.appendChild(bubble);
    thread.appendChild(wrap);
    thread.scrollTop = thread.scrollHeight;
  }
</script>
{% endblock %}
