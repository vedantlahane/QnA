---
- name: Deploy Axon backend service
  hosts: webserver
  become: yes
  vars:
    repo_url: "https://github.com/vedantlahane/Axon.git"
    project_root: "/home/{{ ansible_user }}/axon"
    backend_path: "{{ project_root }}/backend"
    venv_path: "{{ backend_path }}/.venv"
    django_manage: "{{ venv_path }}/bin/python manage.py"
    gunicorn_service_name: axon-gunicorn
    gunicorn_bind: 0.0.0.0:8000
    gunicorn_workers: 3
    gunicorn_timeout: 60
    app_packages:
      - python3
      - python3-pip
      - python3-venv
      - git

  pre_tasks:
    - name: Update package cache (Debian/Yum if needed)
      block:
        - name: Update apt cache
          ansible.builtin.apt:
            update_cache: yes
            cache_valid_time: 3600
          when: ansible_facts.os_family == 'Debian'

        - name: Update yum cache
          ansible.builtin.yum:
            update_cache: yes
          when: ansible_facts.os_family in ['RedHat', 'Amazon']

    - name: Install application packages (cross-platform)
      ansible.builtin.package:
        name: "{{ app_packages }}"
        state: present

  tasks:
    - name: Clone or update repository
      ansible.builtin.git:
        repo: "{{ repo_url }}"
        dest: "{{ project_root }}"
        version: main
        update: yes
        force: yes

    - name: Create virtual environment
      ansible.builtin.command: python3 -m venv "{{ venv_path }}"
      args:
        creates: "{{ venv_path }}/bin/activate"

    - name: Install Python dependencies
      ansible.builtin.pip:
        requirements: "{{ backend_path }}/requirements.txt"
        virtualenv: "{{ venv_path }}"
        virtualenv_python: python3

    - name: Ensure Gunicorn is installed in venv
      ansible.builtin.pip:
        name: gunicorn
        virtualenv: "{{ venv_path }}"
        virtualenv_python: python3

    - name: Run database migrations
      ansible.builtin.command: "{{ django_manage }} migrate"
      args:
        chdir: "{{ backend_path }}"
      become_user: "{{ ansible_user }}"

    - name: Collect static files
      ansible.builtin.command: "{{ django_manage }} collectstatic --noinput"
      args:
        chdir: "{{ backend_path }}"
      become_user: "{{ ansible_user }}"

    - name: Ensure DB file owned by app user (if using SQLite)
      ansible.builtin.file:
        path: "{{ backend_path }}/db.sqlite3"
        owner: "{{ ansible_user }}"
        group: "{{ ansible_user }}"
        mode: "0644"
      when: ansible_facts.os_family is defined

    - name: Install Gunicorn systemd unit
      ansible.builtin.template:
        src: ../templates/axon-gunicorn.service.j2
        dest: "/etc/systemd/system/{{ gunicorn_service_name }}.service"
        mode: "0644"
      notify:
        - Reload systemd
        - Restart Gunicorn

    - name: Ensure /etc/axon dir exists for environment file
      ansible.builtin.file:
        path: "/etc/axon"
        state: directory
        mode: "0755"

    - name: Install backend environment file
      ansible.builtin.template:
        src: ../templates/axon.env.j2
        dest: /etc/axon/axon.env
        mode: "0640"
        owner: root
        group: root
      notify:
        - Reload systemd
        - Restart Gunicorn

    - name: Ensure Gunicorn service is enabled
      ansible.builtin.service:
        name: "{{ gunicorn_service_name }}"
        state: started
        enabled: yes

    - name: Reduce Gunicorn workers if using file-backed SQLite database
      ansible.builtin.set_fact:
        gunicorn_workers: 1
      when: (backend_env.DATABASE_URL | default('') == '') and (gunicorn_workers | int > 1)

    - name: Wait for Gunicorn to start and respond on localhost
      ansible.builtin.uri:
        url: "http://127.0.0.1:8000{{ backend_health_endpoint | default('/api/') }}"
        method: GET
        status_code: 200
        timeout: 5
      register: app_health
      retries: 5
      delay: 3
      until: app_health.status == 200

  handlers:
    - name: Reload systemd
      ansible.builtin.systemd:
        daemon_reload: yes

    - name: Restart Gunicorn
      ansible.builtin.service:
        name: "{{ gunicorn_service_name }}"
        state: restarted

